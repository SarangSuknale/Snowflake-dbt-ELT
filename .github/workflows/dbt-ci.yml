name: dbt CI

on:
  pull_request:

jobs:
  dbt-ci:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: dbt_models

    env:
      DBT_PROFILES_DIR: ../profiles
      DBT_TARGET: test

      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE_TEST: ${{ secrets.SNOWFLAKE_ROLE_TEST }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dbt
        run: |
          pip install --upgrade pip
          pip install dbt-core dbt-snowflake

      - name: Install dbt packages
        run: dbt deps

      - name: Download prod manifest
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: dbt-prod.yml
          name: dbt-manifest
          path: dbt_models/state
        continue-on-error: true

      - name: Verify manifest
        run: |
          echo "Checking state directory"
          ls -R state || echo "No manifest found"

      - name: dbt compile
        run: dbt compile --target test

      - name: dbt build 
        run: |
          if [ -f state/manifest.json ]; then
            echo "Running Slim CI"
            dbt build \
              --target test \
              --select state:modified+ \
              --defer \
              --state state
          else
            echo "Manifest not found, running full build"
            dbt build --target test
          fi
